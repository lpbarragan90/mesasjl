
<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>Mapa de Mesas (M√≥vil + Roles Abreviados + Iconos)</title>
<style>
    :root{
      --seat-size: 56px;
      --wrap-size: 100vw;
      --table-size: 240px;
      --radius: 160px;
      --sidebar-width: 360px;
    }
    @media (min-width: 900px){
      :root{ --wrap-size: 520px; --table-size: 260px; --radius: 210px; }
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color:#0f172a; background:#f8fafc; }
    header { padding: 12px 14px; border-bottom:1px solid #e5e7eb; display:flex; gap:8px; align-items:center; background:#fff; position: sticky; top: 0; z-index: 20; }
    header h1 { margin:0; font-size:18px; }
    .btn { padding:10px 12px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; font-size:14px; }
    .btn:active { transform: translateY(1px); }
    .btn.small { padding:4px 8px; font-size:12px; border-radius: 999px; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .main { padding: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: repeat(auto-fill, minmax(560px, 1fr)); } }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,.05); background:#fff; }
    .header2 { display:flex; justify-content:space-between; align-items:center; margin-bottom: 6px; }
    .muted { color:#64748b; }
    .small { font-size: 12px; color:#64748b; }
    .table-wrap { position: relative; width: min(var(--wrap-size), 560px); height: min(var(--wrap-size), 560px); margin: 6px auto; }
    .clear-btn { position:absolute; top: -6px; right: 8px; z-index: 5; }
    .table { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width: var(--table-size); height: var(--table-size); border-radius:50%;
             background: radial-gradient(ellipse at center, #f1f5f9 0%, #e2e8f0 100%); border: 3px solid #cbd5e1; display:flex; align-items:center; justify-content:center; font-weight:700; color:#334155; }
    .table .monogram { font-size: 34px; font-weight: 800; letter-spacing: 2px; color:#475569; opacity:.7; }
    .table .amp { margin: 0 6px; font-weight: 900; color:#9b87f5; }
    .seat { width: var(--seat-size); height: var(--seat-size); border-radius: 50%; border: 2px solid #94a3b8; background:#f8fafc;
            display:flex; align-items:center; justify-content:center; font-size:12px; text-align:center; padding:4px;
            position:absolute; user-select:none; z-index: 2; transition: background .15s, border-color .15s; }
    .seat.empty { border-style: dashed; color:#94a3b8; background:#f1f5f9; }
    /* Role colors */
    .role-foto   { background:#e0e7ff; border-color:#6366f1; color:#111; }
    .role-cm     { background:#fecaca; border-color:#ef4444; color:#111; }
    .role-sk     { background:#fef3c7; border-color:#f59e0b; color:#111; }
    .role-pp     { background:#dcfce7; border-color:#22c55e; color:#111; }
    .role-single { background:#ffe4e6; border-color:#fb7185; color:#111; }
    .role-inv    { background:#f8fafc; border-color:#94a3b8; color:#111; }
    .label { position:absolute; width: 260px; text-align:center; font-size: 12px; color:#111; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 3; }
    .selector { position:absolute; width: 90px; z-index: 3; font-size:11px; padding:1px 3px; }
    .badge { position:absolute; font-size: 16px; line-height: 1; z-index: 4; pointer-events: none; }
    .warn { color:#b45309; background:#fff7ed; padding:6px 8px; border-radius:8px; border:1px solid #fde68a; margin:8px 0; }
    .ok { color:#065f46; background:#ecfdf5; padding:6px 8px; border-radius:8px; border:1px solid #a7f3d0; margin:8px 0; }
    .bottombar { position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); background:#ffffffcc; backdrop-filter: blur(6px); border:1px solid #e5e7eb; border-radius: 999px; padding:8px; display:flex; gap:8px; z-index: 30; }
    .bottombar .btn { font-size:13px; padding:8px 10px; }
    .drawer { position: fixed; top:0; right: -100%; width: 92vw; max-width: 420px; height: 100vh; background:#fff; box-shadow: -4px 0 16px rgba(0,0,0,.08); z-index: 40; transition: right .2s; display:flex; flex-direction:column; }
    .drawer.open { right: 0; }
    .drawer header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 12px; border-bottom:1px solid #e5e7eb; }
    .drawer .body { padding: 12px; overflow:auto; }
    .side-search { margin-bottom:8px; display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; }
    .guest-item { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px; margin-bottom:8px; box-shadow: 0 1px 1px rgba(0,0,0,.03); }
    .guest-head { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .guest-name { font-weight:600; }
    .guest-group { font-size:12px; color:#64748b; }
    .guest-input { width:100%; font-size:14px; margin-top:6px; padding:8px; }
    .highlight { outline: 3px solid #60a5fa; border-radius: 12px; }
    .status { position: sticky; top:0; z-index:5; }
    .counter { font-size: 12px; color:#475569; margin-bottom: 8px; }
  </style>

<link href="manifest.webmanifest" rel="manifest"/>
<meta content="#111827" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<link href="icons/icon-192.png" rel="apple-touch-icon"/>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
</script>
</head>
<body>
<header>
<button class="btn" id="openDrawer">Invitados</button>
<h1>Mesas (M√≥vil)</h1>
<div style="flex:1"></div>
<button class="btn" id="exportPDF">PDF</button>
<button class="btn" id="exportXLSX">Excel</button>
<button class="btn" id="exportCSV">CSV</button>
</header>
<div class="main">
<div class="status" id="status"></div>
<div class="grid" id="app"></div>
</div>
<div class="bottombar">
<button class="btn primary" id="save">Guardar</button>
<button class="btn" id="undo">Deshacer</button>
<button class="btn" id="import">Importar</button>
<button class="btn" id="exportJSON">Exportar</button>
</div>
<input accept=".json" id="fileInput" style="display:none" type="file"/>
<div class="drawer" id="drawer">
<header>
<strong>Invitados</strong>
<button class="btn" id="closeDrawer">Cerrar</button>
</header>
<div class="body">
<div class="side-search">
<input id="searchGuest" placeholder="Buscar invitado o grupo..." type="text"/>
<button class="btn" id="btnSearch">Buscar</button>
<button class="btn" id="clearSearch">X</button>
</div>
<div class="counter" id="counter"></div>
<div class="small muted">Asignados se ocultan autom√°ticamente. Edita nombres aqu√≠. No se permiten <strong>nombres duplicados</strong>.</div>
<div id="guestList"></div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script>
    const STORAGE_KEY = "plan_mesas_jl_pwa_sync_v1"; // new key for this version
    const PEOPLE_ORIG = {"1": {"Nombre": "Nora Sanchez", "GRUPO": "FAMILIA JENNY"}, "2": {"Nombre": "Rafael Barradas Palmeros", "GRUPO": "FAMILIA JENNY"}, "3": {"Nombre": "Raquel S√°nchez Ortiz", "GRUPO": "FAMILIA JENNY"}, "4": {"Nombre": "Rom√°n S√°nchez Ort√≠z", "GRUPO": "FAMILIA JENNY"}, "5": {"Nombre": "Roxana Aguirre Aldana", "GRUPO": "FAMILIA JENNY"}, "6": {"Nombre": "Santa Teresa S√°nchez Ort√≠z", "GRUPO": "FAMILIA JENNY"}, "7": {"Nombre": "Sergio Barbabosa S√°nchez", "GRUPO": "FAMILIA JENNY"}, "8": {"Nombre": "Sergio barbabosa gonzalez", "GRUPO": "FAMILIA JENNY"}, "9": {"Nombre": "Shani Yaminah Andrade Garc√≠a", "GRUPO": "FAMILIA JENNY"}, "10": {"Nombre": "Susana Guadalupe Mtz Caraza", "GRUPO": "FAMILIA JENNY"}, "11": {"Nombre": "Invitado Esmeralda 1", "GRUPO": "FAMILIA JENNY"}, "12": {"Nombre": "Invitado Tio Roman 1", "GRUPO": "FAMILIA JENNY"}, "13": {"Nombre": "Invitado Tio Roman 2", "GRUPO": "FAMILIA JENNY"}, "14": {"Nombre": "Isabel", "GRUPO": "FAMILIA JENNY"}, "15": {"Nombre": "Jesus Guerrero L√≥pez", "GRUPO": "FAMILIA JENNY"}, "16": {"Nombre": "Jos√© Alberto Caraza Aldana", "GRUPO": "FAMILIA JENNY"}, "17": {"Nombre": "Laura Patricia Barradas S√°nchez", "GRUPO": "FAMILIA JENNY"}, "18": {"Nombre": "Leticia Barradas S√°nchez", "GRUPO": "FAMILIA JENNY"}, "19": {"Nombre": "Mar√≠a de la Paz S√°nchez Ort√≠z", "GRUPO": "FAMILIA JENNY"}, "20": {"Nombre": "Mar√≠ana Mart√≠nez Caraza", "GRUPO": "FAMILIA JENNY"}, "21": {"Nombre": "Alberto Caraza S√°nchez", "GRUPO": "FAMILIA JENNY"}, "22": {"Nombre": "Alejandro Barradas Sanchez", "GRUPO": "FAMILIA JENNY"}, "23": {"Nombre": "Angelica Garc√≠a Leal", "GRUPO": "FAMILIA JENNY"}, "24": {"Nombre": "Cesar S√°nchez Torres", "GRUPO": "FAMILIA JENNY"}, "25": {"Nombre": "Eduardo Caraza", "GRUPO": "FAMILIA JENNY"}, "26": {"Nombre": "Esmeralda Anaid Barbabosa S√°nchez", "GRUPO": "FAMILIA JENNY"}, "27": {"Nombre": "Evelia Aldana Tapia", "GRUPO": "FAMILIA JENNY"}, "28": {"Nombre": "Gloria Caraza Aldana", "GRUPO": "FAMILIA JENNY"}, "29": {"Nombre": "Guadalupe  Delgado Rosado", "GRUPO": "FAMILIA JENNY"}, "30": {"Nombre": "Invitado 3", "GRUPO": "FAMILIA JENNY"}, "31": {"Nombre": "Ariz Arteaga S√°nchez", "GRUPO": "FAMILIA JENNY"}, "32": {"Nombre": "Gerardo Garreon Falfan", "GRUPO": "FAMILIA JENNY"}, "33": {"Nombre": "Margarita Enriquez", "GRUPO": "FAMILIA JENNY"}, "34": {"Nombre": "Matilde Dominguez Ledezma", "GRUPO": "FAMILIA JENNY"}, "35": {"Nombre": "Rosa Elba S√°nchez Ort√≠z", "GRUPO": "FAMILIA JENNY"}, "36": {"Nombre": "Alejandro Medina Granados", "GRUPO": "FAMILIA LUIS"}, "37": {"Nombre": "Arlette Lorenzo Moreno", "GRUPO": "FAMILIA LUIS"}, "38": {"Nombre": "Felix Esposo de Raquel", "GRUPO": "FAMILIA LUIS"}, "39": {"Nombre": "Manuela del Carmen Morales Moreno", "GRUPO": "FAMILIA LUIS"}, "40": {"Nombre": "Raquel Morales Garcia", "GRUPO": "FAMILIA LUIS"}, "41": {"Nombre": "Andrea Islas Mart√≠nez", "GRUPO": "FAMILIA LUIS"}, "42": {"Nombre": "Claudia Mart√≠nez Moreno", "GRUPO": "FAMILIA LUIS"}, "43": {"Nombre": "David Morales Moreno", "GRUPO": "FAMILIA LUIS"}, "44": {"Nombre": "Francisco Morales", "GRUPO": "FAMILIA LUIS"}, "45": {"Nombre": "H√©ctor islas", "GRUPO": "FAMILIA LUIS"}, "46": {"Nombre": "Isabel toto", "GRUPO": "FAMILIA LUIS"}, "47": {"Nombre": "Jos√© Manuel Z√∫√±iga", "GRUPO": "FAMILIA LUIS"}, "48": {"Nombre": "Jos√© Santiago Aranda Balderas", "GRUPO": "FAMILIA LUIS"}, "49": {"Nombre": "Mar√≠a del Rosario Garc√≠a", "GRUPO": "FAMILIA LUIS"}, "50": {"Nombre": "Tia Martiza", "GRUPO": "FAMILIA LUIS"}, "51": {"Nombre": "Ana Judith Moreno Garcia", "GRUPO": "FAMILIA LUIS"}, "52": {"Nombre": "Enrique Lorenzo Moreno", "GRUPO": "FAMILIA LUIS"}, "53": {"Nombre": "Estefan√≠a Calderon Staines", "GRUPO": "FAMILIA LUIS"}, "54": {"Nombre": "Guadalupe Alanis", "GRUPO": "FAMILIA LUIS"}, "55": {"Nombre": "Marilu garcia gomez", "GRUPO": "FAMILIA LUIS"}, "56": {"Nombre": "Martha Aguilar", "GRUPO": "FAMILIA LUIS"}, "57": {"Nombre": "Montserrat Alanis", "GRUPO": "FAMILIA LUIS"}, "58": {"Nombre": "Oscar Lorenzo Moreno", "GRUPO": "FAMILIA LUIS"}, "59": {"Nombre": "Pablo Gerardo Morales Aguilar", "GRUPO": "FAMILIA LUIS"}, "60": {"Nombre": "Xochilt Moreno Garc√≠a", "GRUPO": "FAMILIA LUIS"}, "61": {"Nombre": "Enfermera Tia Judith", "GRUPO": "FAMILIA LUIS"}, "62": {"Nombre": "Jos√© Fernando Rodriguez Morales", "GRUPO": "FAMILIA LUIS"}, "63": {"Nombre": "Mar√≠a Estela P√©rez", "GRUPO": "FAMILIA LUIS"}, "64": {"Nombre": "Nicolas Medina Lorenzo", "GRUPO": "FAMILIA LUIS"}, "65": {"Nombre": "Ninfa Ojeda", "GRUPO": "FAMILIA LUIS"}, "66": {"Nombre": "Regina Medina Lorenzo", "GRUPO": "FAMILIA LUIS"}, "67": {"Nombre": "Rosa Isela Morales Moreno", "GRUPO": "FAMILIA LUIS"}, "68": {"Nombre": "Adriana Schiffer Figueroa", "GRUPO": "SCOTIA"}, "69": {"Nombre": "Fernanda novia de Omar", "GRUPO": "SCOTIA"}, "70": {"Nombre": "Omar Saavedra Sanch√©z", "GRUPO": "SCOTIA"}, "71": {"Nombre": "Antonio Gonzalez Guti√©rrez", "GRUPO": "SCOTIA"}, "72": {"Nombre": "Enrique Almaraz Villegas", "GRUPO": "SCOTIA"}, "73": {"Nombre": "Esposa Enrique Almaraz", "GRUPO": "SCOTIA"}, "74": {"Nombre": "Fernando de la Peza Zerme√±o", "GRUPO": "SCOTIA"}, "75": {"Nombre": "Juan Antonio Carrancedo", "GRUPO": "SCOTIA"}, "76": {"Nombre": "Laura Enriquez Musi", "GRUPO": "SCOTIA"}, "77": {"Nombre": "Norma S√°nchez Valenzuela", "GRUPO": "SCOTIA"}, "78": {"Nombre": "Oscar Cruz Cruz", "GRUPO": "SCOTIA"}, "79": {"Nombre": "Ricardo Aguilar Moran", "GRUPO": "SCOTIA"}, "80": {"Nombre": "Samantha Hern√°ndez Zamora", "GRUPO": "SCOTIA"}, "81": {"Nombre": "Alejandro Riva Palacio Friederichsen", "GRUPO": "SCOTIA"}, "82": {"Nombre": "Cristina Villalobos", "GRUPO": "SCOTIA"}, "83": {"Nombre": "Daniel Rebollar Barrera", "GRUPO": "SCOTIA"}, "84": {"Nombre": "Esposa de Humberto", "GRUPO": "SCOTIA"}, "85": {"Nombre": "Gilberto Cabral Haro", "GRUPO": "SCOTIA"}, "86": {"Nombre": "Humberto Aliseda Marin", "GRUPO": "SCOTIA"}, "87": {"Nombre": "Novia de Gilberto", "GRUPO": "SCOTIA"}, "88": {"Nombre": "Quetzal Sierra", "GRUPO": "SCOTIA"}, "89": {"Nombre": "Susana esposa de Alejandro", "GRUPO": "SCOTIA"}, "90": {"Nombre": "Thalia Osorno Garcia", "GRUPO": "SCOTIA"}, "91": {"Nombre": "Valeria Arteaga Restrepo", "GRUPO": "AMIGA CERCANA"}, "92": {"Nombre": "Yali Valencia Uscanga", "GRUPO": "AMIGA CERCANA"}, "93": {"Nombre": "Alejandro Campos Castellanos", "GRUPO": "SCOTIA"}, "94": {"Nombre": "Esposo Rossana", "GRUPO": "SCOTIA"}, "95": {"Nombre": "F√©lix Villagran Aguilera", "GRUPO": "SCOTIA"}, "96": {"Nombre": "Mariana Moreno Arjona", "GRUPO": "SCOTIA"}, "97": {"Nombre": "Rosalia Mena Farfan", "GRUPO": "SCOTIA"}, "98": {"Nombre": "Rossana Lagunes Zaldivar", "GRUPO": "SCOTIA"}, "99": {"Nombre": "Stephanie Jimenez Mendoza", "GRUPO": "SCOTIA"}, "100": {"Nombre": "Tulio Alberto de Nova Ferreiro", "GRUPO": "SCOTIA"}, "101": {"Nombre": "Invitado Lila", "GRUPO": "AMIGA CERCANA"}, "102": {"Nombre": "Invitado Valeria", "GRUPO": "AMIGA CERCANA"}, "103": {"Nombre": "Isis Gonz√°lez", "GRUPO": "AMIGA CERCANA"}, "104": {"Nombre": "Jorge Malpica", "GRUPO": "AMIGA CERCANA"}, "105": {"Nombre": "Leyci Salomon Morales", "GRUPO": "AMIGA CERCANA"}, "106": {"Nombre": "Mar√≠a Fernanda Reva Gil", "GRUPO": "AMIGA CERCANA"}, "107": {"Nombre": "Moises Thomas Meunier", "GRUPO": "AMIGA CERCANA"}, "108": {"Nombre": "Olga Vanery Alarcon S√°nchez", "GRUPO": "AMIGA CERCANA"}, "109": {"Nombre": "Selene Valencia Uscanga", "GRUPO": "AMIGA CERCANA"}, "110": {"Nombre": "Tomas M√©ndez Guti√©rrez", "GRUPO": "AMIGA CERCANA"}, "111": {"Nombre": "Alejandro morales", "GRUPO": "AMIGA CERCANA"}, "112": {"Nombre": "Alma Lilia Quintero Morales", "GRUPO": "AMIGA CERCANA"}, "113": {"Nombre": "Angel Teutli", "GRUPO": "AMIGA CERCANA"}, "114": {"Nombre": "Felipe Guti√©rrez Altamirano", "GRUPO": "AMIGA CERCANA"}, "115": {"Nombre": "Francisco Toledo Mtz.", "GRUPO": "AMIGA CERCANA"}, "116": {"Nombre": "Invitado Monss", "GRUPO": "AMIGA CERCANA"}, "117": {"Nombre": "Jessica Grahanda Cristaldi", "GRUPO": "AMIGA CERCANA"}, "118": {"Nombre": "Karen Fern√°ndez Peguero", "GRUPO": "AMIGA CERCANA"}, "119": {"Nombre": "Mary Velazquez Garc√≠a", "GRUPO": "AMIGA CERCANA"}, "120": {"Nombre": "Monserrat Arevalo Pena", "GRUPO": "AMIGA CERCANA"}, "121": {"Nombre": "Alfonso L√≥pez Arellano", "GRUPO": "AMIGA CERCANA"}, "122": {"Nombre": "Ana Z√°rate Gonzalez", "GRUPO": "AMIGA CERCANA"}, "123": {"Nombre": "Angie Monrroy", "GRUPO": "AMIGA CERCANA"}, "124": {"Nombre": "Diego Riojas Malo", "GRUPO": "AMIGO"}, "125": {"Nombre": "Fernando Basurto Longo", "GRUPO": "AMIGO"}, "126": {"Nombre": "Guillermo Ziaurriz", "GRUPO": "AMIGO"}, "127": {"Nombre": "Mariana Riojas Malo", "GRUPO": "AMIGO"}, "128": {"Nombre": "Mario Riojas", "GRUPO": "AMIGO"}, "129": {"Nombre": "Sandra Rodr√≠guez Diaz", "GRUPO": "AMIGO"}, "130": {"Nombre": "Yolanda Malo", "GRUPO": "AMIGO"}, "131": {"Nombre": "Daniel Rodr√≠guez", "GRUPO": "AMIGO"}, "132": {"Nombre": "Daniela chapa", "GRUPO": "AMIGO"}, "133": {"Nombre": "Esposa de Ricardo Ortiz", "GRUPO": "AMIGO"}, "134": {"Nombre": "Gabriela Capetillo", "GRUPO": "AMIGO"}, "135": {"Nombre": "Javier Francisco Salda√±a Gonzalez", "GRUPO": "AMIGO"}, "136": {"Nombre": "Jorge Arrieta", "GRUPO": "AMIGO"}, "137": {"Nombre": "Leonora T√©llez", "GRUPO": "AMIGO"}, "138": {"Nombre": "Ricardo Ort√≠z", "GRUPO": "AMIGO"}, "139": {"Nombre": "Uriel Larios Ojeda", "GRUPO": "AMIGO"}, "140": {"Nombre": "Yamile Croda", "GRUPO": "AMIGO"}, "141": {"Nombre": "Alejandro Alarcon", "GRUPO": "AMIGO"}, "142": {"Nombre": "Antonio Alexis Arroyo", "GRUPO": "AMIGO"}, "143": {"Nombre": "Daniel Cienfuegos", "GRUPO": "AMIGO"}, "144": {"Nombre": "Edgar Ferman", "GRUPO": "AMIGO"}, "145": {"Nombre": "Ingrid Lenz", "GRUPO": "AMIGO"}, "146": {"Nombre": "Miguel √Ångel Hern√°ndez", "GRUPO": "AMIGO"}, "147": {"Nombre": "Sra Grace esposa de salda√±a", "GRUPO": "AMIGO"}, "148": {"Nombre": "Ulises Gonzalez", "GRUPO": "AMIGO"}, "149": {"Nombre": "Cristina Basurto Longo", "GRUPO": "AMIGO CERCANO"}, "150": {"Nombre": "Gerardo T√©llez Ruiz", "GRUPO": "AMIGO CERCANO"}, "151": {"Nombre": "Aldo Fong Rodr√≠guez", "GRUPO": "AMIGO CERCANO"}, "152": {"Nombre": "Alejandro Cuesta Garc√≠a", "GRUPO": "AMIGO CERCANO"}, "153": {"Nombre": "Ana Elisa Mares Villegas", "GRUPO": "AMIGO CERCANO"}, "154": {"Nombre": "Arturo Escobar", "GRUPO": "AMIGO CERCANO"}, "155": {"Nombre": "Blanca Mar√≠a Urrea Valdez", "GRUPO": "AMIGO CERCANO"}, "156": {"Nombre": "Karen C√≥rdoba", "GRUPO": "AMIGO CERCANO"}, "157": {"Nombre": "Luis Alberto Larios Ojeda", "GRUPO": "AMIGO CERCANO"}, "158": {"Nombre": "Mario Arenas", "GRUPO": "AMIGO CERCANO"}, "159": {"Nombre": "Raquel Colorado Subizar", "GRUPO": "AMIGO CERCANO"}, "160": {"Nombre": "Vania Suzette Martinez Cort√©s", "GRUPO": "AMIGO CERCANO"}, "161": {"Nombre": "Daniel Basurto Longo", "GRUPO": "AMIGO CERCANO"}, "162": {"Nombre": "Esposa Razo", "GRUPO": "AMIGO CERCANO"}, "163": {"Nombre": "Francisco Razo", "GRUPO": "AMIGO CERCANO"}, "164": {"Nombre": "Luis Felipe Higueras Reyes", "GRUPO": "AMIGO CERCANO"}, "165": {"Nombre": "Carlos Rodr√≠guez Marroquin", "GRUPO": "AMIGO PAPA"}, "166": {"Nombre": "Gabriela cuevas cortes", "GRUPO": "AMIGO PAPA"}, "167": {"Nombre": "Jos√© David Reyna", "GRUPO": "AMIGO PAPA"}, "168": {"Nombre": "Lizbeth Ram√≠rez de David", "GRUPO": "AMIGO PAPA"}, "169": {"Nombre": "Raul Pe√±a Gurrion", "GRUPO": "AMIGO PAPA"}, "170": {"Nombre": "Sonia Zetina Gomez", "GRUPO": "AMIGO PAPA"}, "171": {"Nombre": "Alma Regalado √Åvila", "GRUPO": "AMIGO PAPA"}, "172": {"Nombre": "Andr√©s Guti√©rrez cruz", "GRUPO": "AMIGO PAPA"}, "173": {"Nombre": "Francisco Z√°rate Cano", "GRUPO": "AMIGO PAPA"}, "174": {"Nombre": "Georgiana escobar avula", "GRUPO": "AMIGO PAPA"}, "175": {"Nombre": "Invitado Sra Juanita", "GRUPO": "AMIGO PAPA"}, "176": {"Nombre": "Josefa Su√°rez D√≠az", "GRUPO": "AMIGO PAPA"}, "177": {"Nombre": "Juanita S√°nchez P√©rez", "GRUPO": "AMIGO PAPA"}, "178": {"Nombre": "Mariela  Herrera Rivadeneyra", "GRUPO": "AMIGO PAPA"}, "179": {"Nombre": "Oscar Ruiz Kat", "GRUPO": "AMIGO PAPA"}, "180": {"Nombre": "Rubicelia Sibaja de Ruiz", "GRUPO": "AMIGO PAPA"}, "181": {"Nombre": "Aldy Ricardez Fonseca", "GRUPO": "AMIGA"}, "182": {"Nombre": "Daniel Charis Carrasco", "GRUPO": "AMIGA"}, "183": {"Nombre": "Invitado Natalia Perez", "GRUPO": "AMIGA"}, "184": {"Nombre": "Jes√∫s Hern√°ndez", "GRUPO": "AMIGA"}, "185": {"Nombre": "Juan Perea", "GRUPO": "AMIGA"}, "186": {"Nombre": "Leydi Martinez Jimenez", "GRUPO": "AMIGA"}, "187": {"Nombre": "Natalia P√©rez", "GRUPO": "AMIGA"}, "188": {"Nombre": "Nay Acosta", "GRUPO": "AMIGA"}, "189": {"Nombre": "Raul Carranco", "GRUPO": "AMIGA"}, "190": {"Nombre": "Ximena Aguillon", "GRUPO": "AMIGA"}, "191": {"Nombre": "Bruno Doerrer", "GRUPO": "ALEMANES"}, "192": {"Nombre": "Daniel Doerrer", "GRUPO": "ALEMANES"}, "193": {"Nombre": "Jonas Moeckel", "GRUPO": "ALEMANES"}, "194": {"Nombre": "Lissy Doerrer", "GRUPO": "ALEMANES"}, "195": {"Nombre": "Steffy Doerrer", "GRUPO": "ALEMANES"}, "196": {"Nombre": "Annie Lopez del Castillo", "GRUPO": "AMIGA"}, "197": {"Nombre": "Edgar eduardo vargas montero", "GRUPO": "AMIGA"}, "198": {"Nombre": "Jes√∫s M√©ndez", "GRUPO": "AMIGA"}, "199": {"Nombre": "Pamela P√©rez Solorzano", "GRUPO": "AMIGA"}, "200": {"Nombre": "Samantha Perez Villegas", "GRUPO": "AMIGA"}};
    const SEATS_ORIG = {"1": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "2": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "3": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "4": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "5": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "6": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "7": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "8": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "9": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "10": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "11": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "12": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "13": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "14": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "15": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "16": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "17": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "18": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "19": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}], "20": [{"Seat": 1, "ID": null, "ROL": "INV"}, {"Seat": 2, "ID": null, "ROL": "INV"}, {"Seat": 3, "ID": null, "ROL": "INV"}, {"Seat": 4, "ID": null, "ROL": "INV"}, {"Seat": 5, "ID": null, "ROL": "INV"}, {"Seat": 6, "ID": null, "ROL": "INV"}, {"Seat": 7, "ID": null, "ROL": "INV"}, {"Seat": 8, "ID": null, "ROL": "INV"}, {"Seat": 9, "ID": null, "ROL": "INV"}, {"Seat": 10, "ID": null, "ROL": "INV"}]};
    const MESAS = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];

    // Roles abreviados
    const ROLES = ["Foto","CM","SK","PP","Single","INV"];
    const ROLE_FULL = { "Foto":"Fot√≥grafo", "CM":"Capit√°n de Mesa", "SK":"Shot King", "PP":"Party Popper", "Single":"Soltero", "INV":"Invitado" };
    const ROLE_CLASS = { "Foto":"role-foto", "CM":"role-cm", "SK":"role-sk", "PP":"role-pp", "Single":"role-single", "INV":"role-inv" };
    const ROLE_ICON = { "Foto":"üì∑", "CM":"üß¢", "SK":"ü•É", "PP":"üéâ", "Single":"üî•", "INV":"" };

    let PEOPLE = JSON.parse(JSON.stringify(PEOPLE_ORIG));
    const modelo = new Map();
    MESAS.forEach(m => modelo.set(m, JSON.parse(JSON.stringify(SEATS_ORIG[m])))); // all empty

    const undoStack = [];
    function snapshot(){
      return {
        people: JSON.parse(JSON.stringify(PEOPLE)),
        seats: MESAS.reduce((acc,m)=>{ acc[m]=JSON.parse(JSON.stringify(modelo.get(m))); return acc; }, {})
      };
    }
    function pushUndo(){ undoStack.push(snapshot()); if (undoStack.length>50) undoStack.shift(); }
    function restore(snap){
      PEOPLE = snap.people;
      MESAS.forEach(m => modelo.set(m, JSON.parse(JSON.stringify(snap.seats[m]))));
      render();
    }

    // Restore if previously saved
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved){ try{ restore(JSON.parse(saved)); }catch{} }

    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot())); actualizarStatus("Guardado en el dispositivo."); }
    function autoSave(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot())); }

    function actualizarStatus(msg, warn=false){
      const el = document.getElementById('status');
      el.innerHTML = `<div class="${warn?'warn':'ok'}">${msg}</div>`;
      setTimeout(()=>{el.innerHTML="";}, 2500);
    }

    function seatsUsed(m){ return modelo.get(m).filter(s=>s.ID!==null).length; }
    function roleClass(rol){ return ROLE_CLASS[rol] || "role-inv"; }
    function roleIcon(rol){ return ROLE_ICON[rol] || ""; }

    function seatPos(index){
      const wrap = Math.min(560, window.innerWidth - 32);
      const cx = wrap/2, cy = wrap/2;
      const R = Math.min(wrap/2 - 40, 220);
      const angle = (Math.PI * 2) * (index / 10) - Math.PI/2;
      const x = cx + R * Math.cos(angle);
      const y = cy + R * Math.sin(angle);
      const offset = 28;
      return {left: x - offset, top: y - offset};
    }

    function removeIDEverywhere(id){
      MESAS.forEach(m => modelo.get(m).forEach(s=>{ if (s.ID===id){ s.ID=null; s.ROL="INV"; } }));
    }

    // Drawer hide assigned logic
    function isSeated(id){
      for (const m of MESAS){
        if (modelo.get(m).some(s=>s.ID===id)) return true;
      }
      return false;
    }

    // Names uniqueness
    function nombreExiste(nuevo, exceptID=null){
      const target = (nuevo||"").trim().toLowerCase();
      if (!target) return false;
      for (const [id, obj] of Object.entries(PEOPLE)){
        if (exceptID && String(id)===String(exceptID)) continue;
        if ((obj.Nombre||"").trim().toLowerCase() === target) return true;
      }
      return false;
    }
    function setNombreID(id, nuevo){
      const val = (nuevo||"").trim();
      if (!val){ actualizarStatus("El nombre no puede estar vac√≠o.", true); return; }
      if (nombreExiste(val, id)){ actualizarStatus("Ese nombre ya existe. No se permiten duplicados.", true); renderGuestList(); render(); return; }
      pushUndo();
      PEOPLE[id].Nombre = val;
      autoSave();
      renderGuestList();
      render();
    }

    // Select & place
    let selectedID = null;
    function selectGuest(id){
      selectedID = id;
      actualizarStatus(`Seleccionado: ${PEOPLE[id].Nombre}`);
      try { closeDrawer(); } catch(e) {}
    }
    function placeOnSeat(mesa, seatIdx){
      const s = modelo.get(mesa)[seatIdx];
      if (!selectedID) { actualizarStatus("Primero selecciona un invitado en el panel.", true); return; }
      pushUndo();
      if (s.ID && s.ID !== selectedID){
        let origin = null;
        for (const m of MESAS){
          const idx = modelo.get(m).findIndex(x=>x.ID===selectedID);
          if (idx>=0){ origin = {m, idx}; break; }
        }
        if (origin){
          const src = modelo.get(origin.m)[origin.idx];
          const temp = s.ID; s.ID = selectedID; src.ID = temp;
        } else {
          removeIDEverywhere(selectedID);
          s.ID = selectedID;
        }
      } else {
        removeIDEverywhere(selectedID);
        s.ID = selectedID;
      }
      autoSave();
      render();
    }

    function setRol(mesa, seatIdx, newRol){
      pushUndo();
      modelo.get(mesa)[seatIdx].ROL = newRol;
      autoSave();
      render();
    }

    // Drawer & list
    function openDrawer(){ document.getElementById('drawer').classList.add('open'); renderGuestList(); }
    function closeDrawer(){ document.getElementById('drawer').classList.remove('open'); }
    function filteredGuests(){
      const q = document.getElementById('searchGuest').value.toLowerCase().trim();
      const arr = Object.entries(PEOPLE).map(([id, obj])=>({id: Number(id), ...obj}));
      const unseated = arr.filter(p => !isSeated(p.id));
      const filtered = !q ? unseated :
        unseated.filter(p => (p.Nombre||"").toLowerCase().includes(q) || (p.GRUPO||"").toLowerCase().includes(q));
      return filtered.sort((a,b)=> a.GRUPO.localeCompare(b.GRUPO) || a.Nombre.localeCompare(b.Nombre));
    }
    function renderGuestList(){
      const box = document.getElementById('guestList');
      const counter = document.getElementById('counter');
      const list = filteredGuests();
      box.innerHTML = "";
      counter.textContent = `Invitados sin asignar: ${list.length}`;
      list.forEach(p => {
        const item = document.createElement('div');
        item.className = 'guest-item';
        item.dataset.guestId = p.id;
        const head = document.createElement('div');
        head.className = 'guest-head';
        const left = document.createElement('div');
        left.innerHTML = `<div class="guest-name">${p.Nombre || "‚Äî"}</div><div class="guest-group">${p.GRUPO || ""}</div>`;
        const right = document.createElement('div');
        const selectBtn = document.createElement('button');
        selectBtn.className = 'btn small'; selectBtn.textContent = 'Seleccionar';
        selectBtn.onclick = ()=> selectGuest(p.id);
        right.appendChild(selectBtn);
        head.appendChild(left); head.appendChild(right);
        item.appendChild(head);
        const input = document.createElement('input');
        input.type = 'text';
        input.value = p.Nombre || "";
        input.placeholder = "Editar nombre";
        input.className = 'guest-input';
        input.onchange = (e)=> {
          const val = (e.target.value||"").trim();
          const exists = Object.entries(PEOPLE).some(([oid, obj]) => Number(oid)!==p.id && (obj.Nombre||"").trim().toLowerCase()===val.toLowerCase());
          if (exists){ actualizarStatus("Ese nombre ya existe. No se permiten duplicados.", true); e.target.value = PEOPLE[p.id].Nombre || ""; return; }
          setNombreID(p.id, val);
        };
        input.onkeydown = (e)=>{ if (e.key==="Enter"){ e.target.blur(); } };
        item.appendChild(input);
        box.appendChild(item);
      });
    }

    // Clear mesa
    function clearMesa(mesa){
      pushUndo();
      modelo.get(mesa).forEach(s=>{ s.ID=null; s.ROL="INV"; });
      autoSave();
      render();
      actualizarStatus(`Mesa ${mesa} limpiada.`);
    }

    // Render helpers
    function roleSelectEl(mesa, seatIdx){
      const sel = document.createElement('select');
      const s = modelo.get(mesa)[seatIdx];
      ROLES.forEach(r=>{
        const o = document.createElement('option'); o.value = r; o.textContent = r;
        if (s.ROL === r) o.selected = true;
        sel.appendChild(o);
      });
      sel.onchange = e => setRol(mesa, seatIdx, e.target.value);
      return sel;
    }
    function seatEl(mesa, seatIdx){
      const s = modelo.get(mesa)[seatIdx];
      const seat = document.createElement('div');
      seat.className = 'seat ' + (s.ID ? roleClass(s.ROL) : 'empty');
      const pos = seatPos(seatIdx);
      seat.style.left = pos.left + "px";
      seat.style.top = pos.top + "px";
      seat.dataset.seat = `${mesa}-${seatIdx}`;
      seat.onclick = ()=> placeOnSeat(mesa, seatIdx);
      seat.innerHTML = s.ID ? (PEOPLE[s.ID].Nombre.split(" ").map(w=>w[0]).filter(Boolean).slice(0,2).join("").toUpperCase()) : "Vac√≠o";
      seat.title = s.ID ? (PEOPLE[s.ID].Nombre + "\n" + PEOPLE[s.ID].GRUPO + "\nRol: " + (ROLE_FULL[s.ROL]||s.ROL)) : "Vac√≠o";
      return seat;
    }
    function badgeEl(mesa, seatIdx){
      const s = modelo.get(mesa)[seatIdx];
      const icon = s.ID ? roleIcon(s.ROL) : "";
      if (!icon) return null;
      const pos = seatPos(seatIdx);
      const b = document.createElement('div');
      b.className = 'badge';
      b.style.left = (pos.left + 22) + "px";
      b.style.top = (pos.top - 16) + "px"; // slightly above the circle
      b.textContent = icon;
      return b;
    }
    function labelEl(mesa, seatIdx){
      const s = modelo.get(mesa)[seatIdx];
      const pos = seatPos(seatIdx);
      const div = document.createElement('div');
      div.className = 'label';
      div.style.left = (pos.left - 110) + "px";
      div.style.top = (pos.top + 44) + "px";
      const full = s.ID ? PEOPLE[s.ID].Nombre : "‚Äî";
      div.textContent = full ? full.slice(0,20) : "‚Äî";
      div.title = full;
      return div;
    }
    function roleSelectorEl(mesa, seatIdx){
      const pos = seatPos(seatIdx);
      const el = roleSelectEl(mesa, seatIdx);
      el.className = 'selector';
      el.style.left = (pos.left - 45) + "px"; // narrower selector
      el.style.top = (pos.top + 74) + "px";
      return el;
    }
    function renderMesaCard(m){
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('div');
      header.className = 'header2';
      header.innerHTML = `<div><strong>Mesa ${m}</strong></div><div class="small muted">Asientos: ${seatsUsed(m)}/10</div>`;
      card.appendChild(header);

      const wrap = document.createElement('div');
      wrap.className = 'table-wrap';

      const clear = document.createElement('button');
      clear.className = 'btn small clear-btn';
      clear.textContent = '‚úï';
      clear.title = 'Limpiar asignaci√≥n de esta mesa';
      clear.onclick = ()=> clearMesa(m);
      wrap.appendChild(clear);

      const table = document.createElement('div');
      table.className = 'table';
      table.innerHTML = '<div class="monogram">J<span class="amp">&amp;</span>L</div>';
      wrap.appendChild(table);

      for (let i=0;i<10;i++){
        wrap.appendChild(seatEl(m, i));
        const badge = badgeEl(m, i); if (badge) wrap.appendChild(badge);
        wrap.appendChild(labelEl(m, i));
        wrap.appendChild(roleSelectorEl(m, i));
      }

      card.appendChild(wrap);
      return card;
    }
    function render(){
      const app = document.getElementById('app');
      app.innerHTML = "";
      MESAS.forEach(m => app.appendChild(renderMesaCard(m)));
      renderGuestList();
    }

    // Search best match among unseated
    function lev(a,b){
      a = a.toLowerCase(); b = b.toLowerCase();
      const m = a.length, n = b.length;
      const dp = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++){
        for (let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }
    function bestMatch(q){
      q = (q||"").trim(); if (!q) return null;
      let best = null, bestScore = Infinity;
      for (const [id, obj] of Object.entries(PEOPLE)){
        const nid = Number(id);
        if (isSeated(nid)) continue;
        const name = obj.Nombre || "";
        const parts = name.split(" ");
        const score = Math.min( lev(q, name), lev(q, parts[0]||""), lev(q, parts.slice(-1)[0]||"") );
        if (score < bestScore){ best = {id:nid, name}; bestScore = score; }
      }
      return best;
    }
    function onBuscar(){
      const q = document.getElementById('searchGuest').value;
      const best = bestMatch(q);
      if (!best){ actualizarStatus("No se encontraron coincidencias (o ya est√°n asignados).", true); return; }
      const card = document.querySelector(`[data-guest-id="${best.id}"]`);
      if (card){ card.classList.add('highlight'); card.scrollIntoView({behavior:"smooth", block:"center"}); setTimeout(()=>card.classList.remove('highlight'),1500); }
    }

    // Exporters
    function recolectarDatos(){
      const rows = [];
      MESAS.forEach(m => {
        const seats = modelo.get(m);
        seats.forEach(s=>{
          const person = s.ID ? PEOPLE[s.ID] : {Nombre:"", GRUPO:""};
          rows.push({Mesa: m, Asiento: s.Seat, ID: s.ID||"", Nombre: person.Nombre, GRUPO: person.GRUPO, ROL: s.ROL});
        });
      });
      return rows;
    }
    function exportCSV(){
      const rows = recolectarDatos();
      const headers = ["Mesa","Asiento","ID","Nombre","GRUPO","ROL"];
      const esc = (t)=>`"${String(t||'').replaceAll('"','""')}"`;
      const csv = [headers.join(",")].concat(rows.map(r=>[r.Mesa, r.Asiento, r.ID, esc(r.Nombre), esc(r.GRUPO), r.ROL].join(","))).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "Asignacion_Mesas.csv"; a.click();
      URL.revokeObjectURL(url);
    }
    function exportXLSX(){
      try{
        const rows = recolectarDatos();
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Asignacion");
        const resumen = MESAS.map(m=>({Mesa:m, Asientos: seatsUsed(m)}));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(resumen), "Resumen_Mesas");
        XLSX.writeFile(wb, "Asignacion_Mesas.xlsx");
      } catch(e){
        actualizarStatus("No se pudo generar .xlsx. Usa CSV.", true);
      }
    }
    async function exportPDF(){
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF || !window.html2canvas){
        actualizarStatus("No se pudo cargar el generador de PDF.", true);
        return;
      }
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
      const cards = Array.from(document.querySelectorAll('.card'));
      if (cards.length === 0){
        actualizarStatus("No hay mesas para exportar.", true);
        return;
      }
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      let first = true;
      for (const card of cards){
        const prevBoxShadow = card.style.boxShadow;
        card.style.boxShadow = 'none';
        const canvas = await html2canvas(card, { scale: 2, useCORS: true });
        card.style.boxShadow = prevBoxShadow;

        const imgData = canvas.toDataURL('image/png');
        const imgW = pageW - 40;
        const ratio = imgW / canvas.width;
        const imgH = canvas.height * ratio;
        if (!first) pdf.addPage('a4', 'landscape');
        first = false;
        pdf.addImage(imgData, 'PNG', 20, 20, imgW, Math.min(imgH, pageH - 40));
      }
      pdf.save('Asignacion_Mesas.pdf');
    }

    
    // ======== FIRESTORE SYNC (Realtime) ========
    // Reemplaza este objeto con tu configuraci√≥n real de Firebase (Project settings ‚Üí General ‚Üí Your apps ‚Üí Web app).
    const FIREBASE_CONFIG = {
      apiKey: "REPLACE_API_KEY",
      authDomain: "REPLACE_PROJECT_ID.firebaseapp.com",
      projectId: "REPLACE_PROJECT_ID",
      // Si tienes otros campos en tu config (storageBucket, appId, etc.) puedes agregarlos tambi√©n.
    };

    // Lee PLAN_ID de hash o usa el default
    const URL_PLAN = (new URL(location.href).hash.replace('#','').trim()) || '';
    const PLAN_ID = URL_PLAN || 'plan-jl-default';

    // Flag para habilitar/deshabilitar sync (por si quieres trabajar offline sin replicar)
    const SYNC = true;

    try {
      firebase.initializeApp(FIREBASE_CONFIG);
    } catch(e){ /* ya inicializado */ }
    const db = firebase.firestore();
    const docRef = db.collection('plans').doc(PLAN_ID);

    let applyingRemote = false;

    // Subida a la nube (debounced)
    function pushCloud(){
      if (!SYNC) return;
      if (applyingRemote) return;
      const data = snapshot();
      docRef.set(data, { merge: true }).catch(err => console.warn('Push cloud error', err));
    }
    const pushCloudDebounced = (fn => {
      let t = null;
      return () => { clearTimeout(t); t = setTimeout(() => fn(), 500); };
    })(pushCloud);

    // Enlazar guardado local + nube
    const _autoSaveOriginal = autoSave;
    function autoSave(){
      _autoSaveOriginal();
      pushCloudDebounced();
    }

    async function initCloud(){
      if (!SYNC) return;
      try {
        const first = await docRef.get();
        if (!first.exists){
          await docRef.set(snapshot());
        }
        docRef.onSnapshot(snap => {
          if (!snap.exists) return;
          applyingRemote = true;
          try {
            const data = snap.data();
            // Valida estructura m√≠nima
            if (data && data.people && data.seats){
              restore(data);
            }
          } finally {
            applyingRemote = false;
          }
        });
      } catch (e){
        console.warn('initCloud error', e);
      }
    }


    // Bindings
    document.getElementById('openDrawer').onclick = ()=>{ openDrawer(); };
    document.getElementById('closeDrawer').onclick = ()=>{ closeDrawer(); };
    document.getElementById('btnSearch').onclick = onBuscar;
    document.getElementById('clearSearch').onclick = ()=>{ document.getElementById('searchGuest').value=""; renderGuestList(); };
    document.getElementById('save').onclick = saveLocal;
    document.getElementById('undo').onclick = ()=>{ const s=undoStack.pop(); if(s){ restore(s); actualizarStatus("Deshecho."); } };
    document.getElementById('exportJSON').onclick = ()=>{
      const data = snapshot();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "Plan_Mesas.json"; a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById('import').onclick = ()=> document.getElementById('fileInput').click();
    document.getElementById('fileInput').addEventListener('change', (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const data = JSON.parse(ev.target.result);
          restore(data);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          actualizarStatus("Importado y guardado.");
        }catch{
          actualizarStatus("Archivo inv√°lido.", true);
        }
      };
      reader.readAsText(f);
    });
    document.getElementById('exportCSV').onclick = exportCSV;
    document.getElementById('exportXLSX').onclick = exportXLSX;
    document.getElementById('exportPDF').onclick = exportPDF;

    render();
  
    // Iniciar sync en la nube
    initCloud();
</script>
</body>
</html>
